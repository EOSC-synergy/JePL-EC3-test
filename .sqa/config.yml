config:
  node_agent: 'docker_compose'
  deploy_template: '.sqa/docker-compose.yml'
  credentials:
      - id: orviz-github-basic
        username_var: GIT_USER
        password_var: GIT_PASSWORD
      - id: samuel-dockerhub
        username_var: JPL_DOCKERUSER
        password_var: JPL_DOCKERPASS
      - id: ifca_openstack
        variable: OPENSTACK_URL
      - id: ifca_openstack_id
        username_var: OPENSTACK_USER
        password_var: OPENSTACK_PASS
      - id: upv_im_id
        username_var: IM_USER
        password_var: IM_PASS

sqa_criteria:
  SvcQC.Dep:
    repos:
      ec3:
        container: ec3client
        commands:
          - |
            #!/bin/bash
            sleep 5
            if [ -f /im/auth/auth.dat ]; then
              printf "$(cat /im/auth/auth.dat)" "${IM_USER}" "${IM_PASS}" ifca "${OPENSTACK_URL}" "${OPENSTACK_USER}" "${OPENSTACK_PASS}" "VO:eosc-synergy.eu" "IFCA local users" > ${IM_AUTH_FILE}
            else
              ls -al /im/auth
              exit 1
            fi
          - ec3 launch jepl_im_cluster im -a "${IM_AUTH_FILE}" -y
          - ec3 destroy jepl_im_cluster --force
          - ec3 launch jepl_im_cluster kubernetes -a "${IM_AUTH_FILE}" -y
          - ec3 destroy jepl_im_cluster --force
          - ec3 launch jepl_im_cluster openports ubuntu-egi ubuntu-ost -a "${IM_AUTH_FILE}" -y
          - ec3 destroy jepl_im_cluster --force

environment:
  IM_AUTH_FILE: "/im/auth.dat"
  JPL_DOCKERPUSH: "ec3client"
  #JPL_IGNOREFAILURES: "defined"
  #JPL_DOCKERFORCEBUILD: "enabled"
  JPL_WORKSPACEDEBUG: "true"
  JPL_WORKSPACEDEBUGTIMEOUT: "45"

#timeout: 1200